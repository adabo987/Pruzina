<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Simulácia pružiny (WebSocket)</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input { width: 80px; margin: 5px; }
    button { margin: 10px; }
    #springArea {
      width: 200px; height: 300px;
      border: 1px solid #000;
      margin-top: 20px;
      position: relative;
      background: #f8f8f8;
    }
    #ball {
      width: 40px;
      height: 40px;
      background: steelblue;
      border-radius: 50%;
      position: absolute;
      left: 80px;
    }
    svg {
      position: absolute;
      top: 0;
      left: 95px;
      stroke: #2c3e50;
      stroke-width: 2;
      fill: none;
    }
  </style>
</head>
<body>

<h2>Simulácia pružiny (naživo z backendu)</h2>

<form id="springForm" onsubmit="startSimulation(); return false;">
  <label>Hmotnosť (kg):</label><input id="mass" type="number" value="1" required><br>
  <label>Pružinová tuhosť (N/m):</label><input id="k" type="number" value="100" required><br>
  <label>Počiatočná výchylka (m):</label><input id="x0" type="number" step="0.01" value="0.1" required><br>
  <button type="submit">Spustiť simuláciu</button>
</form>

<div id="springArea" onclick="resetSimulation()">
  <svg id="spring" width="20" height="300"></svg>
  <div id="ball"></div>
</div>

<script>
let socket = null;

function generateSpiral(height) {
  const coils = 12;
  const spacing = height / coils;
  let path = `M10,0 `;
  for (let i = 0; i < coils; i++) {
    const y1 = i * spacing;
    const y2 = (i + 0.5) * spacing;
    const y3 = (i + 1) * spacing;
    path += `Q0,${y2} 10,${y3} `;
  }
  return path;
}

function drawSpring(length) {
  const spring = document.getElementById("spring");
  spring.setAttribute("height", length);
  spring.innerHTML = `<path d="${generateSpiral(length)}" />`;
}

function updatePosition(positionCm) {
  const y = 100 + positionCm; // Posun od stropu
  document.getElementById("ball").style.top = `${y}px`;
  drawSpring(y);
}

function startSimulation() {
  const m = parseFloat(document.getElementById("mass").value);
  const k = parseFloat(document.getElementById("k").value);
  const x0 = parseFloat(document.getElementById("x0").value);

  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      method: "init",
      mass: m,
      spring_constant: k,
      initial_displacement: x0,
      damping_ratio: 0.0
    }));
  } else {
    alert("WebSocket nie je pripojený.");
  }
}

function resetSimulation() {
  document.getElementById("ball").style.top = "120px";
  drawSpring(120);
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ method: "reset" }));
  }
}

// WebSocket pripojenie
function connectWebSocket() {
  socket = new WebSocket("ws://localhost:9000");

  socket.onopen = () => {
    console.log("WebSocket pripojený");
  };

  socket.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      if (data.method === "data" && "position" in data) {
        updatePosition(data.position); // Očakáva cm
      }
    } catch (e) {
      console.error("Chyba pri spracovaní správy:", e);
    }
  };

  socket.onerror = (e) => console.error("WebSocket chyba:", e);
  socket.onclose = () => console.log("WebSocket zatvorený");
}

// Inicializácia
connectWebSocket();
resetSimulation();
</script>

</body>
</html>
